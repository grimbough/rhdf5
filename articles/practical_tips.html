<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>**rhdf5** Practical Tips • rhdf5</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="**rhdf5** Practical Tips">
<meta property="og:description" content="rhdf5">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rhdf5</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.35.5-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/rhdf5.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/practical_tips.html">**rhdf5** Practical Tips</a>
    </li>
    <li>
      <a href="../articles/rhdf5_cloud_reading.html">Reading HDF5 Files In The Cloud</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grimbough/rhdf5/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="practical_tips_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>
<strong>rhdf5</strong> Practical Tips</h1>
                        <h4 class="author">Mike L. Smith</h4>
            <address class="author_afil">
      EMBL Heidelberg<br><small class="dont-index">Source: <a href="https://github.com/grimbough/rhdf5/blob/master/vignettes/practical_tips.Rmd"><code>vignettes/practical_tips.Rmd</code></a></small>
      <div class="hidden name"><code>practical_tips.Rmd</code></div>

    </address>
</div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>Provides discussion and practical examples for effectively using <em>rhdf5</em> and the HDF5 file format.</p>
    </div>
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>There are scenarios where the most intuitive approach to working with <em>rhdf5</em> or HDF5 will not be the most efficient. This may be due to unfamiliar bottlenecks when working with data on-disk rather than in memory, or idiosyncrasies in either the HDF5 library itself or the <em>rhdf5</em> package. This vignette is intended to present a collection of hints for circumventing some common pitfalls.</p>
</div>
<div id="reading-subsets-of-data" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-subsets-of-data" class="anchor"></a>Reading subsets of data</h1>
<p>One of the cool features about the HDF5 file format is the ability to read subsets of the data without (necessarily) having to read the entire file, keeping both the memory usage and execution times of these operations to a minimum. However this is not always as performant as one might hope.</p>
<p>To demonstrate we’ll create some example data. This takes the form of a matrix with 100 rows and 20,000 columns, where the content of each column is the index of the column i.e. column 10 contains the value 10 repeated, column 20 contains 20 repeated etc. This is just so we can easily check we’ve extracted the correct columns. We then write this matrix to an HDF5 file, calling the dataset ‘counts’. <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20000</span>, each <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">20000</span>, byrow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">ex_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".h5"</span><span class="op">)</span>
<span class="fu"><a href="../reference/h5write.html">h5write</a></span><span class="op">(</span><span class="va">m1</span>, file <span class="op">=</span> <span class="va">ex_file</span>, name <span class="op">=</span> <span class="st">"counts"</span>, level <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></code></pre></div>
<pre><code>## You created a large dataset with compression and chunking.
## The chunk size is equal to the dataset dimensions.
## If you want to read subsets of the dataset, you should testsmaller chunk sizes to improve read times.</code></pre>
<div id="using-the-index-argument" class="section level2">
<h2 class="hasAnchor">
<a href="#using-the-index-argument" class="anchor"></a>Using the <code>index</code> argument</h2>
<p>Now we’ll use the <code>index</code> argument to selectively extract the first 10,000 columns and time how long this takes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>
  <span class="va">res1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/h5read.html">h5read</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">ex_file</span>, name <span class="op">=</span> <span class="st">"counts"</span>, 
                 index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.034   0.007   0.040</code></pre>
<p>Next, instead of selecting 10,000 consecutive columns we’ll ask for every other column. This should still return the same amount of data and since our dataset is not chunked involves reading the same volume from disk.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">1</span>, to <span class="op">=</span> <span class="fl">20000</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>
  <span class="va">res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/h5read.html">h5read</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">ex_file</span>, name <span class="op">=</span> <span class="st">"counts"</span>, 
                 index <span class="op">=</span> <span class="va">index</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.131   0.010   0.142</code></pre>
<p>As we can see this is massively slower than the previous example. This is because creating unions of hyperslabs is currently very slow in HDF5 (see <a href="https://forum.hdfgroup.org/t/union-of-non-consecutive-hyperslabs-is-very-slow/5062">Union of non-consecutive hyperslabs is very slow</a> for another report of this behaviour), with the performance penalty increasing exponentially relative to the number of unions. When we use the <code>index</code> argument <em>rhdf5</em> creates a hyperslab for each disjoint set of values we want to extract and then merges them. In our first example this only require the creation of a single 100 <span class="math inline">\(\times\)</span> 10,000 hyperslab, where as in the second case we require 10,000 hyperslabs of dimension 100 <span class="math inline">\(\times\)</span> 1 and 9,999 merge operations.</p>
</div>
<div id="using-hyperslab-selections" class="section level2">
<h2 class="hasAnchor">
<a href="#using-hyperslab-selections" class="anchor"></a>Using hyperslab selections</h2>
<p>If there is a regular pattern to the regions you want to access, then it is likely you could also apply use HDF5’s hyperslab selection method ^[The parameters for defining hyperslab selection <code>start</code>, <code>stride</code>, <code>block</code>, &amp; <code>count</code> are not particularly intuitive if you are used to R’s index selection methods. More examples discussing how to specify them can be found at <a href="https://portal.hdfgroup.org/display/HDF5/Reading+From+or+Writing+To+a+Subset+of+a+Dataset">www.hdfgroup.org</a>. The following code defines the parameters to select every other column, the same as in our previous example.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">stride</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>
<span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10000</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span>
  <span class="va">res3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/h5read.html">h5read</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">ex_file</span>, name <span class="op">=</span> <span class="st">"counts"</span>, start <span class="op">=</span> <span class="va">start</span>,
                 stride <span class="op">=</span> <span class="va">stride</span>, block <span class="op">=</span> <span class="va">block</span>, count <span class="op">=</span> <span class="va">count</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.126   0.008   0.139</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">res2</span>, <span class="va">res3</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>This is clearly significantly quicker than using the <code>index</code> argument in the example, and the call to <code><a href="https://rdrr.io/r/base/identical.html">identical()</a></code> confirms we’re returning the same data.</p>
<p><em>rhdf5</em> is sophisticated enough to combine consecutive columns into a single call, so selecting completely disjoint alternative columns represents a worst case scenario. The impact would be far less if, for example, we wanted to extract columns 1 - 5,000 and 6,001 - 11,000. In that scenario it would probably not be noticeably beneficial to move away from using the <code>index</code> argument, but for less contiguous selections making use of the hyperslab selection parameters can be extremely beneficial.</p>
<p><img src="practical_tips_files/figure-html/unnamed-chunk-1-1.png" width="576"></p>
</div>
<div id="irregular-selections" class="section level2">
<h2 class="hasAnchor">
<a href="#irregular-selections" class="anchor"></a>Irregular selections</h2>
<p>If there isn’t a regular pattern to the columns you want to select, what are the options? Perhaps the most obvious thing we can try is to skip the use of either <code>index</code> or the hyperslab parameters and use 10,000 separate read operations instead. Below we choose a random selection of columns and then apply the function <code>f1()</code> to each in turn.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fl">20000</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">10000</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">f1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cols</span>, <span class="va">name</span><span class="op">)</span> <span class="op">{</span> 
  <span class="fu"><a href="../reference/h5read.html">h5read</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">ex_file</span>, name <span class="op">=</span> <span class="va">name</span>, 
         index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">cols</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">res4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">columns</span>, FUN <span class="op">=</span> <span class="va">f1</span>, 
                           FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, 
                           name <span class="op">=</span> <span class="st">'counts'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
## 208.433  45.688 254.555</code></pre>
<p>This is clearly a terrible idea, it takes ages! For reference, using the <code>index</code> argument with this set of columns takes 1.952 seconds. This poor performance is driven by two things:</p>
<ol style="list-style-type: decimal">
<li>Our dataset had no chunking applied to it when it was created. This means for each access the entire dataset is read from disk, which we end up doing 10,000 times.</li>
<li>
<em>rhdf5</em> does a lot of validation on the objects that are passed around internally. Within a call to <code><a href="../reference/h5read.html">h5read()</a></code> HDF5 identifiers are created for the file, dataset, file dataspace, and memory dataspace, each of which are checked for validity. This overhead is negligible when only one call to <code><a href="../reference/h5read.html">h5read()</a></code> is made, but become significant when we make 10,000 separate calls.</li>
</ol>
<p>There’s not much more you can do if the dataset is not chunked, and using the <code>index</code> argument is reasonable. However storing data in this format defeats of of HDF5’s key utilities, namely rapid random access. As such it’s probably fairly rare to encounter datasets that aren’t chunked. With this in mind we’ll create a new dataset in our file, based on the same matrix but this time split into 100 <span class="math inline">\(\times\)</span> 100 chunks.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/h5createDataset.html">h5createDataset</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">ex_file</span>, dataset <span class="op">=</span> <span class="st">"counts_chunked"</span>, 
                dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>, storage.mode <span class="op">=</span> <span class="st">"integer"</span>, 
                chunk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span>, level <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>
<span class="fu"><a href="../reference/h5write.html">h5write</a></span><span class="op">(</span>obj <span class="op">=</span> <span class="va">m1</span>, file <span class="op">=</span> <span class="va">ex_file</span>, name <span class="op">=</span> <span class="st">"counts_chunked"</span><span class="op">)</span></code></pre></div>
<p>If we rerun the same code, but reading from the chunked datasets we get an idea for how much time is wasted exctracted the entire dataset over and over.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">res5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">columns</span>, FUN <span class="op">=</span> <span class="va">f1</span>, 
                           FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>, 
                           name <span class="op">=</span> <span class="st">'counts_chunked'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##  38.333   2.722  41.091</code></pre>
<p>This is still quite slow, and the remaining time is being spent on the overheads associated with multiple calls to <code><a href="../reference/h5read.html">h5read()</a></code>. To reduce these the function <code>f2()</code><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> defined below splits the list of columns we want to return into sets grouped by the parameter <code>block_size</code>. In the default case this means any columns between 1 &amp; 100 will be placed together, then any between 101 &amp; 200, etc. We then <code>lapply</code> our previous <code>f1()</code> function over these groups. The effect here is to reduce the number of calls to <code><a href="../reference/h5read.html">h5read()</a></code>, while keeping the number of hyperslab unions down by not having too many columns in any one call.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">block_size</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">cols_grouped</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">columns</span>,  <span class="op">(</span><span class="va">columns</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="va">block_size</span><span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">cols_grouped</span>, <span class="va">f1</span>, name <span class="op">=</span> <span class="st">'counts_chunked'</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">'cbind'</span>, <span class="va">.</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu">f2</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.801   0.062   1.864</code></pre>
<p>We can see this has a significant effect, although it’s still an order of magnitude slower than when we were dealing with regularly spaced subsets. The efficiency here will vary based on a number of factors including the size of the dataset chunks and the sparsity of the column index, and you varying the <code>block_size</code> argument will produce differing performances. The plot below shows the timings achived by providing a selection of values to <code>block_size</code>. It suggests the optimal parameter in this case is probably a block size of 1000, which took 1.09 seconds - noticeably faster than when passing all columns to the <code>index</code> argument in a single call.</p>
<p><img src="practical_tips_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
<p>Efficiently extracting arbitrary subsets of a HDF5 dataset with <em>rhdf5</em> is a balancing act between the number of hyperslab unions, the number of calls to <code><a href="../reference/h5read.html">h5read()</a></code>, and the number of times a chunk is read. For a (mostly) contiguous subset using the <code>index</code> argument is sufficient, while for regularly spaced but disjoint subsets the hyperslab selection parameters offer an efficient, if slightly more complex, alternative. Otherwise finding the optimal strategy may involve some experimentation in a similar fashion to we have seen above.</p>
<!--





-->
</div>
</div>
<div id="session-info" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session info</h1>
<pre><code>## R version 4.1.0 RC (2021-05-10 r80282)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Catalina 10.15.7
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] ggplot2_3.3.3    dplyr_1.0.6      rhdf5_2.35.5-1   BiocStyle_2.19.2
## 
## loaded via a namespace (and not attached):
##  [1] highr_0.9            bslib_0.2.4          compiler_4.1.0      
##  [4] pillar_1.6.0         BiocManager_1.30.15  jquerylib_0.1.4     
##  [7] rhdf5filters_1.3.5   tools_4.1.0          digest_0.6.27       
## [10] gtable_0.3.0         jsonlite_1.7.2       evaluate_0.14       
## [13] memoise_2.0.0        lifecycle_1.0.0      tibble_3.1.1        
## [16] pkgconfig_2.0.3      rlang_0.4.11         microbenchmark_1.4-7
## [19] yaml_2.2.1           pkgdown_1.6.1        xfun_0.22           
## [22] fastmap_1.1.0        withr_2.4.2          stringr_1.4.0       
## [25] knitr_1.33           desc_1.3.0           generics_0.1.0      
## [28] fs_1.5.0             sass_0.3.1           vctrs_0.3.8         
## [31] systemfonts_1.0.1    grid_4.1.0           tidyselect_1.1.1    
## [34] rprojroot_2.0.2      glue_1.4.2           R6_2.5.0            
## [37] textshaping_0.3.3    fansi_0.4.2          rmarkdown_2.8       
## [40] bookdown_0.22        farver_2.1.0         purrr_0.3.4         
## [43] Rhdf5lib_1.13.7      magrittr_2.0.1       codetools_0.2-18    
## [46] scales_1.1.1         htmltools_0.5.1.1    ellipsis_0.3.2      
## [49] colorspace_2.0-1     labeling_0.4.2       ragg_1.1.2          
## [52] utf8_1.2.1           stringi_1.5.3        munsell_0.5.0       
## [55] cachem_1.0.4         crayon_1.4.1</code></pre>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>You’ll probably see a warning here regarding chunking, something we’ll touch on later<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>This is not the greatest function ever, things like the file name are hardcoded out of sight, but it illustrates the technique.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Bernd Fischer, Mike Smith, Gregoire Pau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
